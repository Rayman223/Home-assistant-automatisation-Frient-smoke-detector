alias: Smoke – Watchdog on HA start
description: >-
  Au redémarrage de Home Assistant, restaure l'état d'alarme si de la fumée est
  déjà détectée et relance la sirène du détecteur source si le silence est inactif.
triggers:
  - event: start
    trigger: homeassistant
conditions:
  - condition: state
    entity_id: binary_sensor.groupe_detection_de_fumee
    state: "on"
actions:
  - variables:
      source: |
        {{ expand('binary_sensor.groupe_detection_de_fumee')
           | selectattr('state','eq','on')
           | map(attribute='entity_id')
           | first }}
      mqtt_name: >-
        {{ source
           | regex_replace('^binary_sensor\\.', '')
           | regex_replace('_smoke$', '') }}
  - data:
      entity_id: input_text.smoke_alarm_source
      value: "{{ source }}"
    action: input_text.set_value
  - action: input_boolean.turn_on
    metadata: {}
    target:
      entity_id: input_boolean.alarm_is_active
    data: {}
  - condition: state
    state:
      - "off"
    entity_id: input_boolean.smoke_alarm_silence
  - data:
      topic: zigbee2mqtt/{{ mqtt_name }}/set
      payload: |-
        {
          "warning":
          {
            "duration": 60,
            "level": "low",
            "mode": "burglar",
            "strobe": false,
            "strobe_duty_cycle": 0
          }
        }
    action: mqtt.publish
mode: single
