alias: Smoke – Propagation sirènes
description: >-
  Propage l'alarme du détecteur source vers les autres détecteurs du groupe
  en publiant les commandes Zigbee2MQTT adaptées.
mode: parallel
fields:
  source_entity:
    selector:
      text: null
    name: source_entity
    required: true
    description: Détecteur source (binary_sensor.xxx_smoke)
  duration_seconds:
    selector:
      text: null
    default: "5"
    name: duration_seconds
    description: Durée en secondes pour les détecteurs secondaires
variables:
  duration: "{{ duration_seconds | default(5) | int }}"
  source_mqtt_name: >-
    {{ source_entity
       | regex_replace('^binary_sensor\\.', '')
       | regex_replace('_smoke$', '') }}
  all_smoke_detectors: |
    {{ expand('binary_sensor.groupe_detection_de_fumee')
       | map(attribute='name')
       | list }}
sequence:
  - condition: state
    state:
      - "off"
    entity_id: input_boolean.smoke_alarm_silence
  - action: input_boolean.turn_on
    target:
      entity_id: input_boolean.alarm_is_active
    data: {}
  - repeat:
      for_each: "{{ all_smoke_detectors }}"
      sequence:
        - variables:
            this_entity: "{{ repeat.item }}"
        - choose:
            - conditions:
                - condition: template
                  value_template: "{{ this_entity == source_mqtt_name }}"
              sequence:
                - data:
                    topic: zigbee2mqtt/{{ this_entity }}/set
                    payload: "{\"alarm\":\"START\"}"
                  action: mqtt.publish
                  enabled: false
            - conditions:
                - condition: template
                  value_template: "{{ this_entity != source_mqtt_name }}"
                - condition: state
                  entity_id: input_boolean.smoke_alarm_silence
                  state: "off"
              sequence:
                - data:
                    topic: zigbee2mqtt/{{ this_entity }}/set
                    payload: |-
                      {
                        "warning": {
                          "duration": {{ duration }},
                          "level": "low",
                          "mode": "burglar",
                          "strobe": false,
                          "strobe_duty_cycle": 0
                        }
                      }
                  action: mqtt.publish
